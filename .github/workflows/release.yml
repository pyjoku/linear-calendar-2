# Automated Release Workflow
# Triggers when a new tag is pushed (e.g., v1.0.0)
#
# Uses Semantic Versioning (SemVer):
# - MAJOR.MINOR.PATCH
# - v1.0.0 - Initial release
# - v1.0.1 - Patch (bug fixes)
# - v1.1.0 - Minor (new features, backwards compatible)
# - v2.0.0 - Major (breaking changes)

name: Release

on:
  push:
    tags:
      - 'v*.*.*'

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run tests
        run: npm test

      - name: Run type check
        run: npm run typecheck

      - name: Build
        run: npm run build

      - name: Get version from tag
        id: version
        run: echo "version=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT

      - name: Update manifest version
        run: |
          jq --arg v "${{ steps.version.outputs.version }}" '.version = $v' manifest.json > manifest.tmp
          mv manifest.tmp manifest.json

      - name: Create release zip
        run: |
          mkdir -p release
          cp main.js manifest.json styles.css release/
          cd release && zip -r ../linear-calendar-2-${{ steps.version.outputs.version }}.zip .

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          name: "Linear Calendar 2 v${{ steps.version.outputs.version }}"
          body: |
            ## Installation

            ### From Community Plugins (Recommended)
            Search for "Linear Calendar 2" in Obsidian's Community Plugins.

            ### Manual Installation
            1. Download `main.js`, `manifest.json`, and `styles.css`
            2. Create folder `.obsidian/plugins/linear-calendar-2/` in your vault
            3. Copy the downloaded files into that folder
            4. Reload Obsidian and enable the plugin

            ---

            See [CHANGELOG.md](https://github.com/pyjoku/linear-calendar-2/blob/main/CHANGELOG.md) for what's new.
          files: |
            main.js
            manifest.json
            styles.css
            linear-calendar-2-${{ steps.version.outputs.version }}.zip
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
